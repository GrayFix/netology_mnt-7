# 08.02 Работа с Playbook

## Описание работы плейбука
1. Плейбук скачивает и настраивает окружение Java и устанавливает Elasticsearch и Kiabana на одном сервере (в inventory указан контейнер docker). 
2. Тэги используемые плейбуком:
   - `java` - установка и настройка Java
   - `elastic` - установка и настройка Elasticsearch
   - `kibana` - установка и настройка Kibana
3. Переменные используемые плейбуком:
   - Общие
     - `java_jdk_version` - версия Java
     - `java_oracle_jdk_package` - файл дистрибутива Java (должен лежать в папке плейбука files)
     - `elk_version` - версия стэка ELK
   - Для Elasticsearch
     - `elastic_home` - путь установки Elasticsearch
   - Для Kibana
     - `kibana_home` - путь установки Kibana
   
## Выводы запуска плейбука
1. Первый запуск
    ```
    PLAY [Install Java] ****************************************************************************************************************************************************

    TASK [Gathering Facts] *************************************************************************************************************************************************
    ok: [centos]

    TASK [Set facts for Java vars] *****************************************************************************************************************************************
    ok: [centos]

    TASK [Download .tar.gz file containing binaries from local storage] ****************************************************************************************************
    diff skipped: source file size is greater than 104448
    changed: [centos]

    TASK [Ensure installation dir exists] **********************************************************************************************************************************
    --- before
    +++ after
    @@ -1,5 +1,5 @@
    {
    -    "mode": "0755",
    +    "mode": "0666",
        "path": "/opt/jdk/11.0.12",
    -    "state": "absent"
    +    "state": "directory"
    }

    changed: [centos]

    TASK [Extract Java in the installation directory] **********************************************************************************************************************
    changed: [centos]

    TASK [Set environment Java] ********************************************************************************************************************************************
    --- before
    +++ after: /root/.ansible/tmp/ansible-local-22160dvs_mejo/tmpoqsd45q6/jdk.sh.j2
    @@ -0,0 +1,5 @@
    +# Warning: This file is Ansible Managed, manual changes will be overwritten on next playbook run.
    +#!/usr/bin/env bash
    +
    +export JAVA_HOME=/opt/jdk/11.0.12
    +export PATH=$PATH:$JAVA_HOME/bin
    \ No newline at end of file

    changed: [centos]

    PLAY [Install Elasticsearch] *******************************************************************************************************************************************

    TASK [Gathering Facts] *************************************************************************************************************************************************
    ok: [centos]

    TASK [Download tar.gz Elasticsearch from remote URL] *******************************************************************************************************************
    changed: [centos]

    TASK [Create directrory for Elasticsearch] *****************************************************************************************************************************
    --- before
    +++ after
    @@ -1,5 +1,5 @@
    {
    -    "mode": "0755",
    +    "mode": "0666",
        "path": "/opt/elastic/7.10.1",
    -    "state": "absent"
    +    "state": "directory"
    }

    changed: [centos]

    TASK [Extract Elasticsearch in the installation directory] *************************************************************************************************************
    changed: [centos]

    TASK [Set environment Elastic] *****************************************************************************************************************************************
    --- before
    +++ after: /root/.ansible/tmp/ansible-local-22160dvs_mejo/tmp7_dmenkk/elk.sh.j2
    @@ -0,0 +1,5 @@
    +# Warning: This file is Ansible Managed, manual changes will be overwritten on next playbook run.
    +#!/usr/bin/env bash
    +
    +export ES_HOME=/opt/elastic/7.10.1
    +export PATH=$PATH:$ES_HOME/bin
    \ No newline at end of file

    changed: [centos]

    PLAY [Install Kibana] **************************************************************************************************************************************************

    TASK [Gathering Facts] *************************************************************************************************************************************************
    ok: [centos]

    TASK [Download tar.gz Kibana from remote URL] **************************************************************************************************************************
    changed: [centos]

    TASK [Create directrory for Kibana] ************************************************************************************************************************************
    --- before
    +++ after
    @@ -1,5 +1,5 @@
    {
    -    "mode": "0755",
    +    "mode": "0666",
        "path": "/opt/kibana/7.10.1",
    -    "state": "absent"
    +    "state": "directory"
    }

    changed: [centos]

    TASK [Extract Kibana in the installation directory] ********************************************************************************************************************
    changed: [centos]

    TASK [Set environment Kibana] ******************************************************************************************************************************************
    --- before
    +++ after: /root/.ansible/tmp/ansible-local-22160dvs_mejo/tmpvjjunq0p/kibana.sh.j2
    @@ -0,0 +1,5 @@
    +# Warning: This file is Ansible Managed, manual changes will be overwritten on next playbook run.
    +#!/usr/bin/env bash
    +
    +export KB_HOME=/opt/kibana/7.10.1
    +export PATH=$PATH:$KB_HOME/bin
    \ No newline at end of file

    changed: [centos]

    PLAY RECAP *************************************************************************************************************************************************************
    centos                     : ok=16   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
    ```
2. Второй запуск
    ```
    PLAY [Install Java] ****************************************************************************************************************************************************

    TASK [Gathering Facts] *************************************************************************************************************************************************
    ok: [centos]

    TASK [Set facts for Java vars] *****************************************************************************************************************************************
    ok: [centos]

    TASK [Download .tar.gz file containing binaries from local storage] ****************************************************************************************************
    ok: [centos]

    TASK [Ensure installation dir exists] **********************************************************************************************************************************
    ok: [centos]

    TASK [Extract Java in the installation directory] **********************************************************************************************************************
    skipping: [centos]

    TASK [Set environment Java] ********************************************************************************************************************************************
    ok: [centos]

    PLAY [Install Elasticsearch] *******************************************************************************************************************************************

    TASK [Gathering Facts] *************************************************************************************************************************************************
    ok: [centos]

    TASK [Download tar.gz Elasticsearch from remote URL] *******************************************************************************************************************
    ok: [centos]

    TASK [Create directrory for Elasticsearch] *****************************************************************************************************************************
    ok: [centos]

    TASK [Extract Elasticsearch in the installation directory] *************************************************************************************************************
    skipping: [centos]

    TASK [Set environment Elastic] *****************************************************************************************************************************************
    ok: [centos]

    PLAY [Install Kibana] **************************************************************************************************************************************************

    TASK [Gathering Facts] *************************************************************************************************************************************************
    ok: [centos]

    TASK [Download tar.gz Kibana from remote URL] **************************************************************************************************************************
    ok: [centos]

    TASK [Create directrory for Kibana] ************************************************************************************************************************************
    ok: [centos]

    TASK [Extract Kibana in the installation directory] ********************************************************************************************************************
    skipping: [centos]

    TASK [Set environment Kibana] ******************************************************************************************************************************************
    ok: [centos]

    PLAY RECAP *************************************************************************************************************************************************************
    centos                     : ok=13   changed=0    unreachable=0    failed=0    skipped=3    rescued=0    ignored=0
    ```